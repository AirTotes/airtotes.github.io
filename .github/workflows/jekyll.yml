name: Deploy Jekyll site to Pages

on:
  push:
    branches: ["main"]

  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  SSH_PRIVATE_KEY_FILE: private.key
  BASE_URL: https://airtote.jp
  OUT_DIR: _site


jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Ruby
        uses: ruby/setup-ruby@0a29871fe2b0200a17a4497bae54fe5df0d973aa # v1.115.3
        with:
          ruby-version: '3.0' # Not needed with a .ruby-version file
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
          cache-version: 0 # Increment this number if you need to re-download cached gems
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v2
      - name: Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ env.BASE_URL }}"
        env:
          JEKYLL_ENV: production

      - name: Change Permission
        run: find ${{ env.OUT_DIR }} -type f -follow -exec chmod 604 '{}' \;

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1

      - name: set private key value
        run: echo "$SSH_PRIVATE_KEY" > ${{ env.SSH_PRIVATE_KEY_FILE }}
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: change permissions of SSH_PRIVATE_KEY_FILE
        run: chmod 600 ${{ env.SSH_PRIVATE_KEY_FILE }}

      - name: Upload files
        env:
          REMOTE_TARGET_DIR: web/airtote-jp/
        run: >
          rsync -av
          -e "ssh -o StrictHostKeyChecking=no -i ${{ env.SSH_PRIVATE_KEY_FILE }} ${{ secrets.SSH_PORT_OPT_ARG }}"
          ${{ env.OUT_DIR }}/
          ${{ secrets.SSH_USER_NAME }}@ssh.lolipop.jp:${{ env.REMOTE_TARGET_DIR }}
